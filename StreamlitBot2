import openai
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

# Configuraci贸n del sidebar para la clave API
with st.sidebar:
    st.markdown(
        "[Get an OpenAI API key](https://platform.openai.com/account/api-keys)")
    st.markdown(
        "[View the source code](https://github.com/streamlit/llm-examples/blob/main/Chatbot.py)")

# T铆tulo de la aplicaci贸n
st.title(" Chatbot con Visualizaci贸n de Datos")

# Subida de archivos CSV
uploaded_file = st.file_uploader("Sube un archivo CSV", type="csv")

# Procesamiento del archivo CSV
if uploaded_file is not None:
    # Leer datos del CSV
    df = pd.read_csv(uploaded_file)

    # Opci贸n para elegir visualizaci贸n
    option = st.selectbox("Elige c贸mo visualizar los datos:", [
                          'Tabla', 'Gr谩fico de Pastel'])

    if option == 'Tabla':
        st.write(df)
    elif option == 'Gr谩fico de Pastel':
        # Asumiendo que el CSV tiene al menos dos columnas
        if df.shape[1] >= 2:
            plt.figure(figsize=(10, 6))
            plt.pie(df[df.columns[1]],
                    labels=df[df.columns[0]], autopct='%1.1f%%')
            plt.title("Gr谩fico de Pastel")
            st.pyplot(plt)
        else:
            st.error(
                "El CSV no tiene las columnas necesarias para un gr谩fico de pastel.")

# Chatbot
# Reemplaza con tu clave API
openai_api_key = "Api"
openai.api_key = openai_api_key

if "messages" not in st.session_state:
    st.session_state["messages"] = []

# Entrada del chat
prompt = st.text_input("Escribe tu mensaje")

# Procesamiento de la entrada del chat
if prompt:
    st.session_state.messages.append({"role": "user", "content": prompt})
    st.write(f"T煤: {prompt}")

    try:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[{"role": msg["role"], "content": msg["content"]}
                      for msg in st.session_state.messages]
        )
        assistant_msg = response.choices[0].message
        st.session_state.messages.append(
            {"role": "assistant", "content": assistant_msg['content']})
        st.write(f"Asistente: {assistant_msg['content']}")
    except Exception as e:
        st.error(f"Ocurri贸 un error: {e}")
